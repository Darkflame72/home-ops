controllers:
  bar-assistant:
    type: statefulset
    containers:
      api:
        image:
          repository: ghcr.io/karlomikus/barassistant
          tag: 5.12.0@sha256:8f80842ba68204331583bde2cda1eed9bcaf8adee748eac9b8a8d7f8c9e125ca
        env:
          APP_URL: &api-url "https://bar.darkflame.dev/bar"
          MEILISEARCH_HOST: http://localhost:7700
          AUTHENTIK_BASE_URL: "https://auth.darkflame.dev/"
          AUTHENTIK_CLIENT_ID:
            valueFrom:
              secretKeyRef:
                name: "bar-assistant-secret"
                key: AUTHENTIK_CLIENT_ID
          AUTHENTIK_CLIENT_SECRET:
            valueFrom:
              secretKeyRef:
                name: "bar-assistant-secret"
                key: AUTHENTIK_CLIENT_SECRET
          AUTHENTIK_REDIRECT_URI: "https://bar.darkflame.dev/oauth/callback"
          MEILISEARCH_KEY:
            valueFrom:
              secretKeyRef:
                name: "bar-assistant-secret"
                key: meili-master-key
          REDIS_HOST: dragonfly.database.svc.cluster.local
          CACHE_DRIVER: redis
          SESSION_DRIVER: redis
          ALLOW_REGISTRATION: false
          ENABLE_PASSWORD_LOGIN: false
      search:
        image:
          repository: docker.io/getmeili/meilisearch
          tag: v1.34.1@sha256:ed207d965b25fe533b39f367f13ce26abff22152acfbf7ab28b1a8c565f22e72
        env:
          MEILI_ENV: production
          MEILI_MASTER_KEY:
            valueFrom:
              secretKeyRef:
                name: "bar-assistant-secret"
                key: meili-master-key
          MEILI_NO_ANALYTICS: true
          MEILI_EXPERIMENTAL_DUMPLESS_UPGRADE: true
  frontend:
    containers:
      salt-rim:
        image:
          repository: ghcr.io/karlomikus/salt-rim
          tag: 4.13.0@sha256:29902e855153766216360e40f5c100169d9da57dd277644ca32da15be6cdcf38
        env:
          API_URL: *api-url
          MEILISEARCH_URL: "https://bar.darkflame.dev/search"
service:
  backend:
    controller: bar-assistant
    ports:
      api:
        port: &port 8080
      search:
        port: &search-port 7700
  frontend:
    controller: frontend
    ports:
      http:
        port: *port
route:
  internal:
    enabled: true
    kind: HTTPRoute
    parentRefs:
      - name: envoy-external
        namespace: network
        sectionName: https
    hostnames:
      - "bar.darkflame.dev"
    rules:
      - matches:
        - path:
            value: "/bar"
        filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: "/"
        backendRefs:
        - name: bar-assistant-backend
          port: *port
      - matches:
        - path:
            value: "/search"
        filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: "/"
        backendRefs:
        - name: bar-assistant-backend
          port: *search-port
      - backendRefs:
        - name: bar-assistant-frontend
          port: *port
persistence:
  data:
    existingClaim: "bar"
    advancedMounts:
      bar-assistant:
        api:
          - path: /var/www/cocktails/storage/bar-assistant
  search:
    suffix: search
    enabled: true
    retain: true
    storageClass: openebs-hostpath
    accessMode: ReadWriteOnce
    size: 1Gi
    advancedMounts:
      bar-assistant:
        search:
          - path: /meili_data
defaultPodOptions:
  securityContext:
    fsGroup: 33
